<!DOCTYPE html>
<html>
	<head>
        <title>uekPlan</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <base href="/">
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
		<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-animate.min.js"></script>
		<style>
			html, body {
				height: 100%;
			}

			.wrap {
				min-height: 100%;
				height: auto;
				margin: 0 auto -60px;
				padding: 0 0 60px;
			}

			.footer {
				height: 60px;
				background-color: #f5f5f5;
				border-top: 1px solid #ddd;
				padding-top: 20px;
			}
		</style>
    </head>
	<body data-ng-app="spaApp" data-ng-cloak>
		<div class="wrap">
			<header>
				<nav class="navbar navbar-inverse navbar-fixed-top">
					<div class="container">
						<div class="navbar-header">
							<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
								<span class="sr-only">Toggle navigation</span>
								<span class="icon-bar"></span>
								<span class="icon-bar"></span>
								<span class="icon-bar"></span>
							</button>
							<a class="navbar-brand" href="#">uekPlan</a>
						</div>
					</div>
				</nav>
			</header>
			<main class="container">
				<div class="container-fluid text-center" style="padding: 100px 15px;">
					<div class="row">
						<div class="col-sm-12">
							<div class="form-group">
								<label for="exampleInputEmail1">Searching term</label>
								<input data-ng-model="query" class="form-control" placeholder="KrZZIs...">
							</div>
							<div class="form-group">
								<label for="exampleInputEmail1">Limit</label>
								<select class="form-control" data-ng-model="limit" data-ng-options="item.value as item.label for item in limitOptions">
								</select>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-4" data-ng-controller="groupCtrl">
							<table class="table table-bordered table-condensed table-striped">
								<caption>Searching results for groups</caption>
								<tr data-ng-repeat="item in links| filter: query | limitTo: limit">
									<td><a href="http://planzajec.uek.krakow.pl/{{item.href}}" target="_blank">{{item.name}}</a></td>
								</tr>
							</table>
							<loading data-ng-show="loadingStatus" ></loading>
						</div>
						<div class="col-sm-4" data-ng-controller="roomCtrl">
							<table class="table table-bordered table-condensed table-striped">
								<caption>Searching results for rooms</caption>
								<tr data-ng-repeat="item in links| filter: query | limitTo: limit">
									<td><a href="http://planzajec.uek.krakow.pl/{{item.href}}" target="_blank">{{item.name}}</a></td>
								</tr>
							</table>
							<loading data-ng-show="loadingStatus" ></loading>
						</div>
						<div class="col-sm-4" data-ng-controller="teacherCtrl">
							<table class="table table-bordered table-condensed table-striped">
								<caption>Searching results for employees</caption>
								<tr data-ng-repeat="item in links| filter: query | limitTo: limit">
									<td><a href="http://planzajec.uek.krakow.pl/{{item.href}}" target="_blank">{{item.name}}</a></td>
								</tr>
							</table>
							<loading data-ng-show="loadingStatus" ></loading>
						</div>
					</div>
				</div>
			</main>
		</div>
		<footer class="footer">
            <div class="container">
                <p class="text-center">{{appVersion}}</p>
            </div>
        </footer>
		<script>
			// create single app module
			var app = angular.module('spaApp', []);

			app.run(function ($rootScope) {
				// define app version
				$rootScope.appVersion = '0.0.1';

				// set limit dropdown options
				$rootScope.limitOptions = [
					{value: 10, label: 10},
					{value: 20, label: 20},
					{value: 50, label: 50},
					{value: 100, label: 100},
					{value: undefined, label: "Unlimited"}
				];

				$rootScope.limit = 10; // set default limit for results
			});

			// create directive for loading element
			app.directive('loading', function () {
				return {
					restrict: 'E',
					replace: true,
					template: '<div class="loading text-center"><img src="http://www.nasa.gov/multimedia/videogallery/ajax-loader.gif" width="20" height="20" /></div>'
				};
			});

			// create service for retrieving and parsing html content from UEK timetable
			app.factory('timetable', ['$http', function ($http) {
					/**
					 * @param {String} type One of the following options is accepted: ["G", "S", "N"]
					 */
					return function (type, $scope) {
						$http({
							method: "get",
							url: "https://crossorigin.me/http://planzajec.uek.krakow.pl/index.php?typ=" + type // get via proxy to bypass origin issue
						}).then(function mySuccess(response) {
							var groups = new DOMParser().parseFromString(response.data, "text/html"); // create dom object from string
							var col = groups.getElementsByClassName('kolumny')[0]; // get parent element for all links
							var hrefs = col.getElementsByTagName('a'); // get all links

							var links = new Array(); // declare output array
							for (var item in hrefs) { // iterate over DOM links
								if (hrefs.hasOwnProperty(item)) {
									// add link to output collection
									links.push({
										name: hrefs[item].innerHTML, // label
										href: hrefs[item].getAttribute('href') // url
									});
								}
							}

							// update view
							$scope.links = links;
							// hide loading spinner
							$scope.loadingStatus = false;
						}, function myError(response) {
							console.log(response.statusText); // output error
						});

					};
				}]);

			// controller for groups
			app.controller('groupCtrl', function ($scope, timetable) {
				$scope.loadingStatus = true; // set on loading spinner
				timetable("G", $scope); // set links view variable via service
			});

			// controller for rooms
			app.controller('roomCtrl', function ($scope, timetable) {
				$scope.loadingStatus = true; // set on loading spinner
				timetable("S", $scope); // set links view variable via service
			});

			// controller for employees
			app.controller('teacherCtrl', function ($scope, timetable) {
				$scope.loadingStatus = true; // set on loading spinner
				timetable("N", $scope); // set links view variable via service
			});
		</script>
	</body>
</html>

